
name: dbt CI

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  dbt:
    runs-on: ubuntu-latest

    env:
      DBT_PROFILES_DIR: ./profiles

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dbt (BigQuery)
        run: |
          python -m pip install --upgrade pip
          pip install dbt-bigquery==1.11.0

      - name: Detect dbt project + profile
        run: |
          set -e

          DBT_PROJECT_FILE="$(find . -maxdepth 6 -name dbt_project.yml -print -quit)"
          if [ -z "$DBT_PROJECT_FILE" ]; then
            echo "ERROR: dbt_project.yml not found (searched up to 6 levels)" >&2
            exit 1
          fi

          DBT_PROJECT_DIR="$(dirname "$DBT_PROJECT_FILE")"
          echo "DBT_PROJECT_DIR=$DBT_PROJECT_DIR" >> "$GITHUB_ENV"

          PROFILE_NAME="$(grep -E '^[[:space:]]*profile:' "$DBT_PROJECT_FILE" | head -n 1 | sed -E 's/^[[:space:]]*profile:[[:space:]]*//; s/"//g; s/'\''//g')"
          if [ -z "$PROFILE_NAME" ]; then
            echo "ERROR: Could not read 'profile:' from $DBT_PROJECT_FILE" >&2
            exit 1
          fi
          echo "PROFILE_NAME=$PROFILE_NAME" >> "$GITHUB_ENV"

          echo "Detected DBT_PROJECT_DIR=$DBT_PROJECT_DIR"
          echo "Detected PROFILE_NAME=$PROFILE_NAME"

      - name: Create CI profiles.yml (no secrets required)
        run: |
          set -e
          mkdir -p profiles

          cat > profiles/profiles.yml <<EOF
          ${PROFILE_NAME}:
            target: ci
            outputs:
              ci:
                type: bigquery
                method: oauth
                project: dummy-ci-project
                dataset: dummy_dataset
                location: US
                threads: 1
          EOF

          echo "Wrote profiles/profiles.yml"
          cat profiles/profiles.yml

      - name: dbt deps
        run: |
          dbt deps --project-dir "$DBT_PROJECT_DIR" --profiles-dir "$DBT_PROFILES_DIR"

      - name: dbt parse
        run: |
          dbt parse --project-dir "$DBT_PROJECT_DIR" --profiles-dir "$DBT_PROFILES_DIR" --target ci

      - name: dbt compile
        run: |
          dbt compile --project-dir "$DBT_PROJECT_DIR" --profiles-dir "$DBT_PROFILES_DIR" --target ci
