name: dbt CI

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  dbt:
    runs-on: ubuntu-latest

    env:
      DBT_PROJECT_DIR: .
      DBT_PROFILES_DIR: ./profiles

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dbt (BigQuery)
        run: |
          python -m pip install --upgrade pip
          pip install dbt-bigquery==1.11.0

      # Create a CI-safe profile so parse/compile doesn't require secrets
      - name: Create CI profiles.yml (no secrets required)
        run: |
          python - <<'PY'
          import yaml
          from pathlib import Path

          project = yaml.safe_load(open("dbt_project.yml"))
          profile_name = project["profile"]

          profiles = {
              profile_name: {
                  "target": "ci",
                  "outputs": {
                      "ci": {
                          "type": "bigquery",
                          "method": "oauth",
                          "project": "dummy-ci-project",
                          "dataset": "dummy_dataset",
                          "location": "US",
                          "threads": 1,
                      }
                  },
              }
          }

          Path("profiles").mkdir(exist_ok=True)
          with open("profiles/profiles.yml", "w") as f:
              yaml.safe_dump(profiles, f, sort_keys=False)

          print("Wrote profiles/profiles.yml for profile:", profile_name)
          PY

      - name: dbt deps
        run: |
          dbt deps --project-dir "$DBT_PROJECT_DIR" --profiles-dir "$DBT_PROFILES_DIR"

      - name: dbt parse
        run: |
          dbt parse --project-dir "$DBT_PROJECT_DIR" --profiles-dir "$DBT_PROFILES_DIR"

      - name: dbt compile
        run: |
          dbt compile --project-dir "$DBT_PROJECT_DIR" --profiles-dir "$DBT_PROFILES_DIR"
